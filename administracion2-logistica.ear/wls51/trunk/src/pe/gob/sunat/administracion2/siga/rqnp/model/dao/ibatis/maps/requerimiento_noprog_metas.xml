<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="requerimientonoprogmetas">

	<typeAlias alias="requerimientoNoProgMetasBean"
		type="pe.gob.sunat.administracion2.siga.rqnp.model.domain.RequerimientoNoProgMetasBean" />
	
	<resultMap id="lstRqnpMetas" class="requerimientoNoProgMetasBean">
		<result property="codigoRqnp" column="CODI_RQNP_SRM" />
		<result property="codigoBien" column="CODI_BSER_CAT" />
		<result property="anioEjec" column="ANNO_EJEC_EJE" />
		<result property="secuenciaMeta" column="SECU_FUNC_SFU" />
		<result property="cantidadTotal" column="CANT_TOTA_DSR" />
		<result property="montoSoles" column="MONT_NACI_DSR" />
		<result property="ubg" column="UBG" />
		<result property="producto" column="PRODUCTO" />
		<result property="meta" column="META" />
		<result property="uuoo" column="UUOO" />
		<result property="metaSiaf" column="META_SIAF"/>
	</resultMap>
	
	<resultMap id="lstMetasUuoo" class="requerimientoNoProgMetasBean">
		<result property="ubg" column="UBG" />
		<result property="producto" column="PRODUCTO" />
		<result property="meta" column="META" />
		<result property="uuoo" column="UUOO" />
		<result property="anioEjec" column="ANNO_EJEC_EJE" />
		<result property="secuenciaMeta" column="SECU_FUNC_SFU" />
		<result property="metaSiaf" column="META_SIAF"/>
	</resultMap>
	
	<select id="selectRqnpMetas" parameterClass="java.util.HashMap" resultMap="lstRqnpMetas">
		SELECT PROYECTOS.CODI_PROY_PRY || ' ' || PROYECTOS.DESC_PROY_PRY AS UBG,
			PROYECTOS.CODI_PROY_PRY || '.' || PRODUCTOS.CODI_PROD_PRD || ' ' || PRODUCTOS.DESC_PROD_PRD AS PRODUCTO,
			PROYECTOS.CODI_PROY_PRY || '.' || PRODUCTOS.CODI_PROD_PRD || '.' || METAS_PRODUCTOS.CODI_META_MET || ' ' || METAS_PRODUCTOS.DESC_LARG_MET AS META,
			TDEPENDENCIAS.UNIDAD_ORGANIZACIONAL || ' ' || TDEPENDENCIAS.DESC_DEPE_TDE AS UUOO,
			REQUERIMIENTO_NO_PROG_METAS.CANT_TOTA_DSR,
			REQUERIMIENTO_NO_PROG_METAS.MONT_NACI_DSR,
			REQUERIMIENTO_NO_PROG_METAS.CODI_RQNP_SRM,
			REQUERIMIENTO_NO_PROG_METAS.CODI_BSER_CAT,
			REQUERIMIENTO_NO_PROG_METAS.ANNO_EJEC_EJE,
			REQUERIMIENTO_NO_PROG_METAS.SECU_FUNC_SFU,
			METAS.CADE_SIAF_CAD || ' ' || METAS_PRESUPUESTALES.DESC_META_SFU AS META_SIAF
		FROM REQUERIMIENTO_NO_PROG_METAS,
			METAS,
			PROYECTOS,
			PRODUCTOS,
			METAS_PRODUCTOS,
			TDEPENDENCIAS,
			METAS_PRESUPUESTALES
		WHERE	REQUERIMIENTO_NO_PROG_METAS.CODI_RQNP_SRM = #cod_req#
			AND REQUERIMIENTO_NO_PROG_METAS.CODI_BSER_CAT = #cod_bien#
			AND METAS.ANNO_EJEC_EJE = REQUERIMIENTO_NO_PROG_METAS.ANNO_EJEC_EJE
			AND METAS.SECU_FUNC_SFU = REQUERIMIENTO_NO_PROG_METAS.SECU_FUNC_SFU
			AND METAS.CODI_PROY_PRY = PROYECTOS.CODI_PROY_PRY
			AND METAS.CODI_PROY_PRY = PRODUCTOS.CODI_PROY_PRY
			AND METAS.CODI_PROD_PRD = PRODUCTOS.CODI_PROD_PRD
			AND METAS.CODI_PROY_PRY = METAS_PRODUCTOS.CODI_PROY_PRY
			AND METAS.CODI_PROD_PRD = METAS_PRODUCTOS.CODI_PROD_PRD
			AND METAS.CODI_META_MET = METAS_PRODUCTOS.CODI_META_MET
			AND METAS.CODI_DEPE_TDE = TDEPENDENCIAS.CODI_DEPE_TDE
			AND PROYECTOS.ESTA_PROY_PRY = 'A'
			AND METAS_PRESUPUESTALES.ANNO_EJEC_EJE = METAS.ANNO_EJEC_EJE
			AND METAS_PRESUPUESTALES.CADE_FUNC_MEF = METAS.CADE_SIAF_CAD
			AND NVL(METAS.CODI_INST_INS,'1') = '1'
		UNION ALL
		SELECT PROYECTOS.CODI_PROY_PRY || ' ' || PROYECTOS.DESC_PROY_PRY AS UBG,
			PROYECTOS.CODI_PROY_PRY || '.' || PRODUCTOS.CODI_PROD_PRD || ' ' || PRODUCTOS.DESC_PROD_PRD AS PRODUCTO,
			PROYECTOS.CODI_PROY_PRY || '.' || PRODUCTOS.CODI_PROD_PRD || '.' || METAS_PRODUCTOS.CODI_META_MET || ' '|| METAS_PRODUCTOS.DESC_LARG_MET AS META,
			TDEPENDENCIAS.UNIDAD_ORGANIZACIONAL || ' ' || TDEPENDENCIAS.DESC_DEPE_TDE AS UUOO,
			0 AS CANT_TOTA_DSR,
			0 AS MONT_NACI_DSR,
			'000',
			'000',
			'000',
			METAS.SECU_FUNC_SFU,
			METAS.CADE_SIAF_CAD || ' ' || METAS_PRESUPUESTALES.DESC_META_SFU AS META_SIAF
		FROM 
			METAS,
			PROYECTOS,
			PRODUCTOS,
			METAS_PRODUCTOS,
			TDEPENDENCIAS,
			METAS_PRESUPUESTALES
		WHERE     
			METAS.CODI_DEPE_TDE = #cod_dep#
			AND METAS.ANNO_EJEC_EJE = #anio_ejec#
			AND METAS.CODI_PROY_PRY = PROYECTOS.CODI_PROY_PRY
			AND METAS.CODI_PROY_PRY = PRODUCTOS.CODI_PROY_PRY
			AND METAS.CODI_PROD_PRD = PRODUCTOS.CODI_PROD_PRD
			AND METAS.CODI_PROY_PRY = METAS_PRODUCTOS.CODI_PROY_PRY
			AND METAS.CODI_PROD_PRD = METAS_PRODUCTOS.CODI_PROD_PRD
			AND METAS.CODI_META_MET = METAS_PRODUCTOS.CODI_META_MET
			AND METAS.CODI_DEPE_TDE = TDEPENDENCIAS.CODI_DEPE_TDE
			AND PROYECTOS.ESTA_PROY_PRY = 'A'
			AND (METAS.ANNO_EJEC_EJE, METAS.SECU_FUNC_SFU) NOT IN (SELECT DISTINCT ANNO_EJEC_EJE, SECU_FUNC_SFU
																	FROM REQUERIMIENTO_NO_PROG_METAS
																	WHERE CODI_RQNP_SRM = #cod_req#
																	AND CODI_BSER_CAT = #cod_bien#)
			AND METAS_PRESUPUESTALES.ANNO_EJEC_EJE = METAS.ANNO_EJEC_EJE
			AND METAS_PRESUPUESTALES.CADE_FUNC_MEF = METAS.CADE_SIAF_CAD
			AND NVL(METAS.CODI_INST_INS,'1') = '1'
		
	</select>
  
	<select id="selectRqnpMetas_bien" parameterClass="java.util.HashMap" resultMap="lstRqnpMetas">
		SELECT
			PROYECTOS.CODI_PROY_PRY||' '||PROYECTOS.DESC_PROY_PRY AS UBG,
			PROYECTOS.CODI_PROY_PRY||'.'||PRODUCTOS.CODI_PROD_PRD||' '||PRODUCTOS.DESC_PROD_PRD AS PRODUCTO,
			PROYECTOS.CODI_PROY_PRY||'.'||PRODUCTOS.CODI_PROD_PRD||'.'||METAS_PRODUCTOS.CODI_META_MET||' '||METAS_PRODUCTOS.DESC_LARG_MET AS META,
			TDEPENDENCIAS.UNIDAD_ORGANIZACIONAL||' '||TDEPENDENCIAS.DESC_DEPE_TDE AS UUOO,
			REQUERIMIENTO_NO_PROG_METAS.CANT_TOTA_DSR,
			REQUERIMIENTO_NO_PROG_METAS.MONT_NACI_DSR,
			REQUERIMIENTO_NO_PROG_METAS.CODI_RQNP_SRM,
			REQUERIMIENTO_NO_PROG_METAS.CODI_BSER_CAT,
			REQUERIMIENTO_NO_PROG_METAS.ANNO_EJEC_EJE,
			REQUERIMIENTO_NO_PROG_METAS.SECU_FUNC_SFU,
			METAS.CADE_SIAF_CAD||' '||METAS_PRESUPUESTALES.DESC_META_SFU AS META_SIAF
			FROM 
			REQUERIMIENTO_NO_PROG_METAS,
			METAS,
			PROYECTOS,
			PRODUCTOS,
			METAS_PRODUCTOS,
			TDEPENDENCIAS,
			METAS_PRESUPUESTALES
			WHERE  METAS.ANNO_EJEC_EJE = REQUERIMIENTO_NO_PROG_METAS.ANNO_EJEC_EJE
			AND METAS.SECU_FUNC_SFU = REQUERIMIENTO_NO_PROG_METAS.SECU_FUNC_SFU
			AND METAS.CODI_PROY_PRY = PROYECTOS.CODI_PROY_PRY
			AND METAS.CODI_PROY_PRY = PRODUCTOS.CODI_PROY_PRY
			AND METAS.CODI_PROD_PRD = PRODUCTOS.CODI_PROD_PRD
			AND METAS.CODI_PROY_PRY = METAS_PRODUCTOS.CODI_PROY_PRY
			AND METAS.CODI_PROD_PRD = METAS_PRODUCTOS.CODI_PROD_PRD
			AND METAS.CODI_META_MET = METAS_PRODUCTOS.CODI_META_MET
			AND METAS.CODI_DEPE_TDE = TDEPENDENCIAS.CODI_DEPE_TDE
			AND PROYECTOS.ESTA_PROY_PRY='A'
			AND METAS_PRESUPUESTALES.ANNO_EJEC_EJE = METAS.ANNO_EJEC_EJE
			AND METAS_PRESUPUESTALES.CADE_FUNC_MEF = METAS.CADE_SIAF_CAD
			<isNotNull prepend="AND" property="cod_req"> REQUERIMIENTO_NO_PROG_METAS.CODI_RQNP_SRM  = #cod_req#</isNotNull>
			<isNotNull prepend="AND" property="cod_bien"> REQUERIMIENTO_NO_PROG_METAS.CODI_BSER_CAT  = #cod_bien#</isNotNull>
	 </select>
	  
	<select id="selectRqnpMetasAuc" parameterClass="java.util.HashMap" resultMap="lstRqnpMetas"> 
		SELECT
			TDEPENDENCIAS.UNIDAD_ORGANIZACIONAL||' '||TDEPENDENCIAS.DESC_DEPE_TDE AS UUOO,
			PROYECTOS.CODI_PROY_PRY||' '||PROYECTOS.DESC_PROY_PRY AS UBG,
			PRODUCTOS.CODI_PROY_PRY||'.'||PRODUCTOS.CODI_PROD_PRD||' '||PRODUCTOS.DESC_PROD_PRD AS PRODUCTO,
			METAS_PRODUCTOS.CODI_PROY_PRY||'.'||METAS_PRODUCTOS.CODI_PROD_PRD||'.'||METAS_PRODUCTOS.CODI_META_MET||' '||METAS_PRODUCTOS.DESC_LARG_MET AS META,
			REQUERIMIENTO_NO_PROG_METAS.CANT_TOTA_DSR,
			REQUERIMIENTO_NO_PROG_METAS.MONT_NACI_DSR,
			REQUERIMIENTO_NO_PROG_METAS.ANNO_EJEC_EJE,
			REQUERIMIENTO_NO_PROG_METAS.CODI_RQNP_SRM,
			REQUERIMIENTO_NO_PROG_METAS.SECU_FUNC_SFU,
			REQUERIMIENTO_NO_PROG_BIENES.CODI_BSER_CAT,
			METAS.CADE_SIAF_CAD||' '||METAS_PRESUPUESTALES.DESC_META_SFU AS META_SIAF
		FROM
			REQUERIMIENTO_NO_PROG_METAS,
			METAS,
			TDEPENDENCIAS,
			PROYECTOS,
			PRODUCTOS,
			METAS_PRODUCTOS,
			REQUERIMIENTO_NO_PROG_BIENES,
			METAS_PRESUPUESTALES
		WHERE
			REQUERIMIENTO_NO_PROG_METAS.ANNO_EJEC_EJE = METAS.ANNO_EJEC_EJE
			AND REQUERIMIENTO_NO_PROG_METAS.SECU_FUNC_SFU = METAS.SECU_FUNC_SFU
			AND TDEPENDENCIAS.CODI_DEPE_TDE = METAS.CODI_DEPE_TDE
			AND PROYECTOS.CODI_PROY_PRY = METAS.CODI_PROY_PRY
			AND PRODUCTOS.CODI_PROY_PRY = METAS.CODI_PROY_PRY
			AND PRODUCTOS.CODI_PROD_PRD = METAS.CODI_PROD_PRD
			AND METAS_PRODUCTOS.CODI_PROY_PRY = METAS.CODI_PROY_PRY
			AND METAS_PRODUCTOS.CODI_PROD_PRD = METAS.CODI_PROD_PRD
			AND METAS_PRODUCTOS.CODI_META_MET = METAS.CODI_META_MET
			AND REQUERIMIENTO_NO_PROG_METAS.CODI_RQNP_SRM = REQUERIMIENTO_NO_PROG_BIENES.CODI_RQNP_SRM 
			AND REQUERIMIENTO_NO_PROG_METAS.CODI_BSER_CAT = REQUERIMIENTO_NO_PROG_BIENES.CODI_BSER_CAT
			AND REQUERIMIENTO_NO_PROG_METAS.CODI_RQNP_SRM = #cod_req#
			AND REQUERIMIENTO_NO_PROG_BIENES.CODI_BSER_CAT=#cod_bien#
			AND METAS_PRESUPUESTALES.ANNO_EJEC_EJE = METAS.ANNO_EJEC_EJE
			AND METAS_PRESUPUESTALES.CADE_FUNC_MEF = METAS.CADE_SIAF_CAD
	</select>
	
	<insert id="insertar" parameterClass="requerimientoNoProgMetasBean">
		INSERT INTO REQUERIMIENTO_NO_PROG_METAS(
		CODI_RQNP_SRM, 
		CODI_BSER_CAT,
		ANNO_EJEC_EJE,
		SECU_FUNC_SFU,
		CANT_TOTA_DSR,
		MONT_NACI_DSR,
		MONT_DOLA_DSR
		)VALUES(
		#codigoRqnp#,
		#codigoBien#,
		#anioEjec#,
		#secuenciaMeta#,
		#cantidadTotal#,
		#montoSoles#,
		#montoDolar#
		)
	</insert>	
	
	<update id="updateMetas"  parameterClass="requerimientoNoProgMetasBean">
		UPDATE  REQUERIMIENTO_NO_PROG_METAS  
		SET CANT_TOTA_DSR = #cantidadTotal#,
		MONT_NACI_DSR = #montoSoles#
		WHERE CODI_RQNP_SRM = 	#codigoRqnp# AND
		CODI_BSER_CAT = #codigoBien# AND
		SECU_FUNC_SFU =#secuenciaMeta#
	</update>
	
	<update id="updateMetasModificaBien"  parameterClass="requerimientoNoProgMetasBean">
		UPDATE  REQUERIMIENTO_NO_PROG_METAS  
		SET MONT_NACI_DSR = #montoSoles#,
		CODI_BSER_CAT = #codigoBien# 
		WHERE CODI_RQNP_SRM = 	#codigoRqnp# AND
		CODI_BSER_CAT = #codigoBien_origen# AND
		SECU_FUNC_SFU =#secuenciaMeta#
	</update>
	
	<delete id="deleteMetas"  parameterClass="requerimientoNoProgMetasBean">
		DELETE  REQUERIMIENTO_NO_PROG_METAS  
		WHERE CODI_RQNP_SRM = 	#codigoRqnp#
		<isNotNull prepend="AND" property="codigoBien"> REQUERIMIENTO_NO_PROG_METAS.CODI_BSER_CAT = #codigoBien#</isNotNull>
		<isNotNull prepend="AND" property="anioEjec"> REQUERIMIENTO_NO_PROG_METAS.ANNO_EJEC_EJE  = #anioEjec#</isNotNull>
		<isNotNull prepend="AND" property="secuenciaMeta"> REQUERIMIENTO_NO_PROG_METAS.SECU_FUNC_SFU = #secuenciaMeta#</isNotNull>
	</delete>
	
<!-- INICIO: DPORRASC -->
	<parameterMap id="sp_replicar_metas_parm"	class="map">
		<parameter property="cod_rqnp" jdbcType="CHAR" javaType="java.lang.String"	mode="IN" />
		<parameter property="cod_bien" jdbcType="CHAR" javaType="java.lang.String"	mode="IN" />		
	</parameterMap>
	
	<procedure id="sp_replicar_metas" parameterMap="sp_replicar_metas_parm" >
		{call SIGA01.SER_RNP.SP_REPLICAR_METAS(?,?)}
	</procedure>
<!-- FIN: DPORRASC -->
	
	
	<select id="selectMetasUuoo" parameterClass="java.util.HashMap" resultMap="lstMetasUuoo">
		SELECT 
			PROYECTOS.CODI_PROY_PRY || ' ' || PROYECTOS.DESC_PROY_PRY AS UBG,
			PROYECTOS.CODI_PROY_PRY || '.' || PRODUCTOS.CODI_PROD_PRD || ' ' || PRODUCTOS.DESC_PROD_PRD AS PRODUCTO,
			PROYECTOS.CODI_PROY_PRY || '.' || PRODUCTOS.CODI_PROD_PRD || '.' || METAS_PRODUCTOS.CODI_META_MET || ' '|| METAS_PRODUCTOS.DESC_LARG_MET AS META,
			METAS.CODI_DEPE_TDE AS UUOO,
			METAS.ANNO_EJEC_EJE,
			METAS.SECU_FUNC_SFU,
			METAS.CADE_SIAF_CAD || ' ' || METAS_PRESUPUESTALES.DESC_META_SFU AS META_SIAF
		FROM 
			METAS,
			PROYECTOS,
			PRODUCTOS,
			METAS_PRODUCTOS,
			TDEPENDENCIAS,
			METAS_PRESUPUESTALES
		WHERE
			METAS.CODI_DEPE_TDE = #codDependencia#
			AND METAS.ANNO_EJEC_EJE = #anioMeta#
			AND METAS.CODI_PROY_PRY = PROYECTOS.CODI_PROY_PRY
			AND METAS.CODI_PROY_PRY = PRODUCTOS.CODI_PROY_PRY
			AND METAS.CODI_PROD_PRD = PRODUCTOS.CODI_PROD_PRD
			AND METAS.CODI_PROY_PRY = METAS_PRODUCTOS.CODI_PROY_PRY
			AND METAS.CODI_PROD_PRD = METAS_PRODUCTOS.CODI_PROD_PRD
			AND METAS.CODI_META_MET = METAS_PRODUCTOS.CODI_META_MET
			AND METAS.CODI_DEPE_TDE = TDEPENDENCIAS.CODI_DEPE_TDE
			AND PROYECTOS.ESTA_PROY_PRY = 'A'
			AND METAS_PRESUPUESTALES.ANNO_EJEC_EJE = METAS.ANNO_EJEC_EJE
			AND METAS_PRESUPUESTALES.CADE_FUNC_MEF = METAS.CADE_SIAF_CAD
			AND NVL(METAS.CODI_INST_INS,'1') = '1'
	</select>
	
	<resultMap id="lstValidaMetaVacia" class="requerimientoNoProgMetasBean">
		<result property="codigoBien" 		column="CODI_BSER_CAT" />
		<result property="cantidadTotal" 	column="CANT_TOTA_DSR" />
		<result property="montoSoles" 		column="MONT_NACI_DSR" />
	</resultMap>
	
	<select id="validaMetaVacia" parameterClass="java.util.HashMap" resultMap="lstValidaMetaVacia"> 
        SELECT DISTINCT 
        RQNPB.CODI_BSER_CAT,
        SUM(RQNPM.CANT_TOTA_DSR) CANT_TOTA_DSR,
        SUM(RQNPM.MONT_NACI_DSR) MONT_NACI_DSR
        FROM REQUERIMIENTO_NO_PROG_BIENES RQNPB, REQUERIMIENTO_NO_PROG_METAS RQNPM 
        WHERE RQNPB.CODI_RQNP_SRM=RQNPM.CODI_RQNP_SRM (+)
        AND RQNPB.CODI_BSER_CAT=RQNPM.CODI_BSER_CAT (+)
        AND RQNPB.CODI_RQNP_SRM=#codRqnp#
        GROUP BY RQNPB.CODI_BSER_CAT
	</select>
	
	<select id="obtenerSecuFuncUuoo" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT M.SECU_FUNC_SFU, M.CADE_SIAF_CAD||' '||METAS_PRESUPUESTALES.DESC_META_SFU AS META_SIAF 
        FROM TDEPENDENCIAS TD, METAS M, METAS_PRESUPUESTALES
            WHERE 
            TD.UNIDAD_ORGANIZACIONAL=#uuoo#
            AND M.CODI_DEPE_TDE=TD.CODI_DEPE_TDE
            AND M.ANNO_EJEC_EJE = EXTRACT(YEAR FROM SYSDATE) 
            AND M.IND_META_UUOO='1'
            AND METAS_PRESUPUESTALES.ANNO_EJEC_EJE = M.ANNO_EJEC_EJE    
            AND METAS_PRESUPUESTALES.CADE_FUNC_MEF = M.CADE_SIAF_CAD  
            AND ROWNUM=1
	</select>
	
	<select id="obtenerCantBien" parameterClass="map" resultClass="java.lang.String">
		SELECT NVL(SUM(RM.CANT_TOTA_DSR),0) T_BIENES 
		FROM REQUERIMIENTO_NO_PROG_METAS RM 
		WHERE RM.CODI_RQNP_SRM=#codigo_rqnp# 
		AND RM.CODI_BSER_CAT=#codigo_bien#
	</select>

	<select id="obtenerMontoRqnp" parameterClass="map" resultClass="java.lang.String">
		SELECT NVL(SUM(RM.MONT_NACI_DSR),0) T_MONTO 
		FROM REQUERIMIENTO_NO_PROG_METAS RM 
		WHERE RM.CODI_RQNP_SRM=#codigo_rqnp# 
		AND RM.CODI_BSER_CAT=#codigo_bien#
	</select>
</sqlMap>
